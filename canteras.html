<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Canteras ¬∑ Publicado</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>

<style>
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  #map{width:100%;height:100vh}

  /* Gris SOLO cuando body tiene la clase .grayscale */
  .grayscale .leaflet-tile-pane{filter:grayscale(100%)}

  /* ‚úÖ Ocultamos toolbar SIEMPRE en publicado */
  #toolbar{display:none !important;}

  .lbl{position:absolute;background:#fff;border:1px solid rgba(0,0,0,.25);border-radius:6px;padding:2px 6px;font-size:12px;color:#111;box-shadow:0 2px 6px rgba(0,0,0,.25);white-space:nowrap;cursor:pointer}
  .label-pane{z-index:600}

  .legend{
    position:absolute;right:10px;bottom:10px;background:rgba(255,255,255,.96);
    border:1px solid #ddd;border-radius:12px;padding:10px;font-size:12px;min-width:260px;max-width:380px;z-index:1000;
  }
  .legend h4{margin:0 0 8px 0;font-size:13px}
  .legend .sheet{border-top:1px solid #eee;padding-top:8px;margin-top:8px}
  .legend .row{display:flex;align-items:center;gap:8px;margin:4px 0;flex-wrap:wrap}
  .legend .swatch{width:14px;height:14px;border-radius:3px;border:1px solid rgba(0,0,0,.2)}
  .legend .sheet-title{display:flex;align-items:center;gap:8px;font-weight:600}
  .legend .actions{margin-left:auto;display:flex;gap:6px}
  .legend .actions button{padding:2px 6px;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer;font-size:11px}
  .legend .actions button:hover{background:#f3f4f6}
  .legend .hint{color:#666;font-size:11px;margin-top:6px}

  .status{
    position:absolute;right:10px;top:10px;background:rgba(255,255,255,.95);
    border:1px solid #ddd;border-radius:10px;padding:8px 10px;font-size:12px;z-index:1000;max-width:520px;white-space:pre-wrap
  }

  /* === PIN DE OBRA ANIMADO === */
  .obra-pin { position: relative; width: 38px; height: 38px; transform: translate(-50%, -100%); pointer-events:auto; }
  .obra-pin .pin { position:absolute; left:0; top:0; width:38px; height:38px; animation: breathe 1.6s ease-in-out infinite; filter: drop-shadow(0 2px 6px rgba(0,0,0,.35)); }
  .obra-pin .halo { position:absolute; left:50%; top:50%; width:14px; height:14px; border-radius:50%; transform: translate(-50%, -20%); background: rgba(211,47,47,.25); animation: pulse 1.6s ease-out infinite; }
  @keyframes breathe { 0% { transform: scale(0.92); opacity:.95 } 50%{ transform: scale(1.20); opacity:1 } 100%{ transform: scale(0.92); opacity:.95 } }
  @keyframes pulse { 0% { box-shadow:0 0 0 0 rgba(211,47,47,.45); opacity:.9 } 70%{ box-shadow:0 0 0 22px rgba(211,47,47,0); opacity:.15 } 100%{ box-shadow:0 0 0 0 rgba(211,47,47,0); opacity:.9 } }

  /* ====== BARRA DE T√çTULO + LOGO ====== */
  .titlebar{
    position:absolute;
    left:10px; bottom:10px;
    display:flex; flex-direction:column; align-items:flex-start; gap:6px;
    z-index:1100;
    background:rgba(255,255,255,.95); border:1px solid #ddd; border-radius:12px; padding:8px 12px;
  }
  .titlebar img{ max-height:48px; max-width:180px; object-fit:contain; border-radius:6px; border:1px solid #eee }
  .titlebar .title{
    min-width:240px; font-weight:700; font-size:16px;
    padding:4px 8px; border-radius:6px; border:1px dashed transparent;
  }

  .published-pill{
    position:absolute; left:10px; top:10px; z-index:1300;
    background:rgba(255,255,255,.95); border:1px solid #ddd;border-radius:999px;
    padding:6px 10px; font-size:12px; font-weight:800;
    display:inline-flex; gap:10px; align-items:center;
  }
</style>
</head>
<body>

<div id="map"></div>

<div class="published-pill">
  <span>üìå MODO PUBLICADO (bloqueado)</span>
</div>

<div class="titlebar" id="titlebar">
  <img id="logoImg" alt="Logo" style="display:none"/>
  <div id="mapTitle" class="title">FUENTES DE SUMINISTRO Y SUBCONTRATACIONES</div>
</div>

<!-- Toolbar queda en el HTML pero oculto por CSS (bloqueado) -->
<div id="toolbar"></div>

<div class="status" id="statusBox">Cargando librer√≠as‚Ä¶</div>

<div class="legend" id="legend">
  <h4>Grupos cargados</h4>
  <div id="legendBody">
    <div class="hint">Cargando Excel‚Ä¶</div>
  </div>
</div>

<script>
(function(){
  function loadScript(src, onload){
    const s=document.createElement('script');
    s.src=src; s.crossOrigin='anonymous'; s.onload=onload;
    s.onerror=()=>console.error('Error cargando', src);
    document.head.appendChild(s);
  }
  loadScript('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js', ()=>{});
  loadScript('https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js', ()=>{});
})();
</script>

<script>
const statusBox = document.getElementById('statusBox');
function setStatus(msg){ statusBox.textContent = msg; }
window.onerror = function(message, source, lineno, colno){
  setStatus('Error JS: ' + message + '\nL√≠nea: ' + lineno + ':' + colno);
};
window.addEventListener('unhandledrejection', (e)=>{
  setStatus('Promesa rechazada: ' + (e.reason && (e.reason.stack || e.reason.message) || e.reason));
});

function waitFor(testFn, timeoutMs=12000){
  return new Promise((res, rej)=>{
    const t0=Date.now();
    const it=setInterval(()=>{
      if(testFn()){ clearInterval(it); res(true); }
      else if(Date.now()-t0>timeoutMs){ clearInterval(it); rej(new Error('timeout')); }
    }, 60);
  });
}

(async function boot(){
  try{ setStatus('Cargando Leaflet‚Ä¶'); await waitFor(()=>!!window.L); }
  catch{ setStatus('No se pudo cargar Leaflet (CDN).'); return; }

  try{ setStatus('Cargando motor Excel‚Ä¶'); await waitFor(()=>!!window.XLSX); }
  catch{ setStatus('No se pudo cargar XLSX (CDN).'); return; }

  setStatus('Iniciando mapa‚Ä¶');

  // ===== Config (tus rutas en GitHub) =====
  const AUTO = {
    excelUrl: 'data/fuentes.xlsx',
    logoUrl:  'asset/LOGO.jpg'
  };

  // ===== Mapa =====
  const map = L.map('map',{zoomControl:true}).setView([40.2,-3.7],5.8);

  const osmGray = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom: 19, attribution: '&copy; OpenStreetMap'
  });
  const cartoGray = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
    maxZoom:19, attribution:'&copy; OpenStreetMap &copy; CARTO'
  });
  const topoColor = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{
    maxZoom: 17, attribution: '&copy; OpenTopoMap (CC-BY-SA) &copy; OpenStreetMap'
  });
  const ortoPNOA = L.tileLayer('https://tms-pnoa-ma.idee.es/1.0.0/pnoa-ma/{z}/{x}/{-y}.jpeg',{
    maxZoom: 20, attribution:'&copy; CNIG/IGN (PNOA MA)'
  });

  osmGray.addTo(map);
  document.body.classList.add('grayscale');

  const baseLayers = {
    'OSM (gris)': osmGray,
    'Carto (gris)': cartoGray,
    'Topogr√°fico (color)': topoColor,
    'Ortofoto (PNOA MA)': ortoPNOA
  };
  L.control.layers(baseLayers, null, { position:'topleft', collapsed:true }).addTo(map);

  function setGrayscaleByLayer(layer){
    const isGray = (layer === osmGray) || (layer === cartoGray);
    document.body.classList.toggle('grayscale', !!isGray);
  }
  map.on('baselayerchange', (e)=> setGrayscaleByLayer(e.layer));
  setGrayscaleByLayer(osmGray);

  osmGray.on('tileerror', ()=>{
    if(map.hasLayer(osmGray)){
      setStatus('Fallo OSM. Cambiando a Carto‚Ä¶');
      try{ map.removeLayer(osmGray); }catch(_){}
      cartoGray.addTo(map);
      setGrayscaleByLayer(cartoGray);
    }
  });

  const labelPane = map.createPane('labels'); labelPane.classList.add('label-pane');
  const obraPane = map.createPane('obraPane'); obraPane.style.zIndex = 1200;

  // ===== Utilidades =====
  const CATEGORY_COLORS = {
    'Suministradores': '#2e7d32',
    'Subcontratistas': '#1565c0',
    'Gestores de Residuos': '#ef6c00'
  };
  const groupColorMap = {};
  function hashCode(str){ let h=0; for(let i=0;i<str.length;i++){ h=(h<<5)-h+str.charCodeAt(i); h|=0; } return Math.abs(h); }
  function hsvToRgb(h,s,v){ let f=(n,k=(n+h/60)%6)=>v-v*s*Math.max(Math.min(k,4-k,1),0); return [f(5),f(3),f(1)]; }
  function rgbToHex(r,g,b){ const c=x=>('0'+Math.round(x*255).toString(16)).slice(-2); return `#${c(r)}${c(g)}${c(b)}`; }
  function colorForGroup(sheet, group){
    const key = sheet+'::'+group;
    if(groupColorMap[key]) return groupColorMap[key];
    const baseHue = (hashCode(key)%360);
    const [r,g,b] = hsvToRgb(baseHue, 0.70, 0.95);
    const hex = rgbToHex(r,g,b);
    groupColorMap[key] = hex; return hex;
  }
  function markerIcon(color='#333'){
    const svg=encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='"+color+"' d='M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z'/></svg>");
    return L.icon({iconUrl:'data:image/svg+xml;charset=UTF-8,'+svg,iconSize:[28,28],iconAnchor:[14,28],popupAnchor:[0,-28]});
  }
  function sheetCategoryColor(sheet){ return CATEGORY_COLORS[sheet] || '#333'; }
  function catColorAlpha(sheet, alpha){
    const hex = sheetCategoryColor(sheet).replace('#','');
    const r=parseInt(hex.substring(0,2),16), g=parseInt(hex.substring(2,4),16), b=parseInt(hex.substring(4,6),16);
    return `rgba(${r},${g},${b},${alpha})`;
  }
  function createObraDivIcon(){
    const html = `
      <div class="obra-pin" aria-label="Localizaci√≥n de la obra">
        <div class="halo"></div>
        <svg class="pin" viewBox="0 0 24 24" width="38" height="38" xmlns="http://www.w3.org/2000/svg">
          <path fill="#d32f2f" d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z"/>
        </svg>
      </div>`;
    return L.divIcon({ className:'', html, iconSize:[0,0], iconAnchor:[0,0], popupAnchor:[0,-28] });
  }
  function slug(s){ return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
  function haversineKm(lat1, lng1, lat2, lng2){
    const R=6371, toRad=d=>d*Math.PI/180;
    const dLat=toRad(lat2-lat1), dLon=toRad(lng2-lng1);
    const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  }

  // ===== Origen fijo =====
  let ORIGIN = { lat: 37.3891, lng: -5.9845, name: 'Obra' };
  let obraMarker = L.marker([ORIGIN.lat, ORIGIN.lng], { icon: createObraDivIcon(), draggable:false, pane:'obraPane', zIndexOffset: 100000 })
    .bindPopup(`<b>Obra</b><br>${ORIGIN.lat.toFixed(5)}, ${ORIGIN.lng.toFixed(5)}`)
    .addTo(map);

  function gmapsDirUrl(destLat, destLng){
    return `https://www.google.com/maps/dir/?api=1&origin=${ORIGIN.lat},${ORIGIN.lng}&destination=${destLat},${destLng}&travelmode=driving`;
  }

  // ===== Geocoding (si en columna C hay texto) =====
  let geoCache={}; const GEO_CACHE_KEY='geoCacheV3';
  try{ geoCache=JSON.parse(localStorage.getItem(GEO_CACHE_KEY)||'{}'); }catch(e){ geoCache={}; }

  async function geocode(text){
    const key=slug(text);
    if(geoCache[key]) return geoCache[key];
    await sleep(250);
    const url=new URL('https://nominatim.openstreetmap.org/search');
    url.searchParams.set('format','json');
    url.searchParams.set('limit','1');
    url.searchParams.set('q', text+', Espa√±a');
    const res=await fetch(url,{headers:{'Accept':'application/json'}});
    if(!res.ok) return null;
    const data=await res.json();
    if(Array.isArray(data)&&data[0]){
      const r={lat:parseFloat(data[0].lat),lng:parseFloat(data[0].lon)};
      geoCache[key]=r;
      localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(geoCache));
      return r;
    }
    return null;
  }

  // ===== Capas / filtros =====
  let layers=[]; let bounds=[]; const legendBody = document.getElementById('legendBody');
  function normalizeSheetName(name){
    const n = slug(name);
    if(n.includes('sumin')) return 'Suministradores';
    if(n.includes('subc'))  return 'Subcontratistas';
    if(n.includes('gest'))  return 'Gestores de Residuos';
    return name || 'Hoja';
  }

  let filters = {};
  function renderLegend(){
    const sheets = Object.keys(filters);
    if(!sheets.length){
      legendBody.innerHTML = `<div class="hint">No hay datos cargados a√∫n.</div>`;
      return;
    }
    const frag = [];
    sheets.forEach(sheet=>{
      const sheetChecked = !!filters[sheet].__checked;
      const groups = filters[sheet].groups || {};
      const sheetColor = sheetCategoryColor(sheet);
      frag.push(`
        <div class="sheet">
          <div class="sheet-title">
            <span class="swatch" style="background:${sheetColor}"></span>
            <label><input type="checkbox" class="chk-sheet" data-sheet="${sheet}" ${sheetChecked?'checked':''}> ${sheet}</label>
            <div class="actions">
              <button class="btn-all" data-sheet="${sheet}">Todos</button>
              <button class="btn-none" data-sheet="${sheet}">Ninguno</button>
            </div>
          </div>
      `);
      Object.keys(groups).forEach(g=>{
        const on = !!groups[g];
        const gcol = colorForGroup(sheet,g);
        frag.push(`
          <div class="row">
            <span class="swatch" style="background:${gcol}"></span>
            <label style="flex:1 1 auto"><input type="checkbox" class="chk-group" data-sheet="${sheet}" data-group="${g}" ${on?'checked':''}> ${g}</label>
          </div>
        `);
      });
      frag.push(`</div>`);
    });
    legendBody.innerHTML = frag.join('');

    legendBody.querySelectorAll('.chk-sheet').forEach(el=>{
      el.addEventListener('change', ()=>{
        const s=el.dataset.sheet; const val=el.checked;
        filters[s].__checked = val;
        Object.keys(filters[s].groups).forEach(g=> filters[s].groups[g]=val);
        applyFilters(); renderLegend();
      });
    });
    legendBody.querySelectorAll('.chk-group').forEach(el=>{
      el.addEventListener('change', ()=>{
        const s=el.dataset.sheet; const g=el.dataset.group;
        filters[s].groups[g] = el.checked;
        const anyOn = Object.values(filters[s].groups).some(v=>v);
        filters[s].__checked = anyOn;
        applyFilters(); renderLegend();
      });
    });
    legendBody.querySelectorAll('.btn-all').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const s=btn.dataset.sheet;
        filters[s].__checked = true;
        Object.keys(filters[s].groups).forEach(g=> filters[s].groups[g]=true);
        applyFilters(); renderLegend();
      });
    });
    legendBody.querySelectorAll('.btn-none').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const s=btn.dataset.sheet;
        filters[s].__checked = false;
        Object.keys(filters[s].groups).forEach(g=> filters[s].groups[g]=false);
        applyFilters(); renderLegend();
      });
    });
  }

  function applyFilters(){
    layers.forEach(Lr=>{
      const sheetOn = filters[Lr.sheet]?.__checked ?? true;
      const groupOn = filters[Lr.sheet]?.groups?.[Lr.group] ?? true;
      const show = sheetOn && groupOn;
      if(show){ if(!map.hasLayer(Lr.marker)) Lr.marker.addTo(map); }
      else{ if(map.hasLayer(Lr.marker)) map.removeLayer(Lr.marker); }
    });
    layoutLabels();
    try{ obraMarker.bringToFront(); }catch(_){}
  }

  function layoutLabels(){
    document.querySelectorAll('.lbl').forEach(el=>el.remove());

    const vis=layers.filter(Lr=> map.hasLayer(Lr.marker));
    const pane=document.querySelector('.label-pane');
    const occ=[]; function ov(a,b){return !(b.x>a.x+a.w || b.x+b.w<a.x || b.y>a.y+a.h || b.y+b.h<a.y);}

    const meas=document.createElement('div');
    meas.className='lbl';
    meas.style.left='-1000px';
    meas.style.top='-1000px';
    meas.style.visibility='hidden';
    pane.appendChild(meas);

    vis.forEach(Lr=>{
      const pt=map.latLngToLayerPoint([Lr.lat,Lr.lng]);
      meas.textContent=Lr.title||'¬∑';
      const bb=meas.getBoundingClientRect();
      const w=bb.width,h=bb.height;

      const steps=[[0,-18],[18,-18],[18,0],[18,18],[0,18],[-18,18],[-18,0],[-18,-18]];
      let placed=null;
      for(let r=1;r<=7 && !placed;r++){
        for(let k=0;k<steps.length && !placed;k++){
          const x=pt.x+steps[k][0]*r, y=pt.y+steps[k][1]*r;
          const rect={x,y,w:w+12,h:h+8};
          const pad={x:x-4,y:y-4,w:w+20,h:h+16};
          if(occ.every(rr=>!ov(pad,rr))) placed=rect;
        }
      }
      if(!placed) placed={x:pt.x+12,y:pt.y-(h+20),w:w+12,h:h+8};
      occ.push(placed);

      const div=document.createElement('div');
      div.className='lbl';
      div.style.left=placed.x+'px';
      div.style.top=placed.y+'px';
      div.style.borderColor = sheetCategoryColor(Lr.sheet);
      div.style.background = catColorAlpha(Lr.sheet, 0.28);
      div.textContent=Lr.title||'¬∑';
      div.onclick=()=>{ map.openPopup(Lr.popup, [Lr.lat,Lr.lng]); };
      pane.appendChild(div);
    });

    meas.remove();
    try{ obraMarker.bringToFront(); }catch(_){}
  }

  map.on('moveend zoomend', layoutLabels);
  window.addEventListener('resize', layoutLabels);

  function clearAll(){
    layers.forEach(Lr=> map.removeLayer(Lr.marker));
    layers=[]; bounds=[];
    companySeenBySheet.clear();
  }

  function addPoint({sheet, group, company, place, coord, pdfName}){
    const pinColor = colorForGroup(sheet, group);

    function popupHtml(){
      const km = haversineKm(ORIGIN.lat, ORIGIN.lng, coord.lat, coord.lng);
      const kmTxt = (km >= 100) ? `${km.toFixed(0)} km` : `${km.toFixed(1)} km`;
      const url = gmapsDirUrl(coord.lat, coord.lng);

      const pdfOk = pdfName && pdfName.toLowerCase().endsWith('.pdf');
      const pdfHref = pdfOk ? `pdfs/${encodeURIComponent(pdfName)}` : null;

      const pdfBlock = pdfHref
        ? `<ul style="margin:4px 0 0 16px;padding:0">
             <li style="margin:2px 0">
               <a href="${pdfHref}" target="_blank" rel="noopener">üìÑ ${pdfName}</a>
             </li>
           </ul>`
        : `<span style="color:#999">Sin PDF asociado</span>`;

      return `
        <div style="font:14px Arial;max-width:480px">
          <h3 style="margin:0 0 4px 0;font-size:16px">${company}</h3>
          <div style="font-size:12px;color:#444;margin:4px 0">Hoja: <b>${sheet}</b> ¬∑ Grupo: <b>${group}</b></div>
          <div style="font-size:12px;color:#666">Posici√≥n: ${place}</div>
          <div style="font-size:12px;color:#111;margin-top:6px">Distancia a obra: <b>${kmTxt}</b></div>
          <div style="margin-top:6px"><a href="${url}" target="_blank" rel="noopener" style="font-size:12px;">üß≠ Ver ruta en Google&nbsp;Maps</a></div>
          <div style="font-size:12px;color:#111;margin-top:8px">Carta de compromiso:</div>
          ${pdfBlock}
          <div style="font-size:11px;color:#666;margin-top:8px">Coord: ${coord.lat.toFixed(5)}, ${coord.lng.toFixed(5)}</div>
        </div>`;
    }

    const popup = L.popup({autoPan:true, closeButton:true});
    const marker = L.marker([coord.lat, coord.lng], {icon: markerIcon(pinColor)});
    marker.bindPopup(popup).addTo(map);

    const id = `pt_${Date.now()}_${Math.random().toString(36).slice(2)}`;
    marker.on('popupopen', ()=>{ popup.setContent(popupHtml()); });

    layers.push({ id, marker, popup, popupHtml, lat:coord.lat, lng:coord.lng, title:company, sheet, group, company, place, pdfName });
    bounds.push([coord.lat, coord.lng]);
  }

  const companySeenBySheet = new Map();
  function normalizeCompanyName(name){
    let s = slug(name).replace(/[&]/g,' y ');
    s = s.replace(/\b(s\.?a\.?u?|s\.?a\.?|s\.?l\.?u?|s\.?l\.?|sau|sa|slu|sl)\b/g,' ');
    s = s.replace(/\b(grupo|obras|servicios|ingenieria|ingenier√≠a|construcciones|construccion)\b/g,' ');
    return s.replace(/\s+/g,' ').trim();
  }
  function isDuplicateInSheet(sheet, company, coord){
    const norm = normalizeCompanyName(company);
    if(!companySeenBySheet.has(sheet)) companySeenBySheet.set(sheet, new Map());
    const mapCompany = companySeenBySheet.get(sheet);
    if(!mapCompany.has(norm)){ mapCompany.set(norm, [coord]); return false; }
    const arr = mapCompany.get(norm);
    const dup = arr.some(c => haversineKm(c.lat,c.lng,coord.lat,coord.lng) < 0.075);
    if(!dup) arr.push(coord);
    return dup;
  }

  async function handleExcelArrayBuffer(ab){
    clearAll();
    setStatus('Leyendo Excel‚Ä¶');

    const wb = XLSX.read(ab, {type:'array'});
    filters = {}; let added = 0;

    for(const rawName of wb.SheetNames){
      const alias = normalizeSheetName(rawName);
      const sheet = wb.Sheets[rawName]; if(!sheet) continue;

      const rows = XLSX.utils.sheet_to_json(sheet, {header:1, defval:'', blankrows:false});
      if(!rows || !rows.length) continue;

      const first = rows[0].map(v=>String(v).toLowerCase());
      const looksHeader =
        first.join(' ').includes('grupo') ||
        first.join(' ').includes('tipo') ||
        first.join(' ').includes('empresa') ||
        first.join(' ').includes('posici√≥n') ||
        first.join(' ').includes('posicion') ||
        first.join(' ').includes('localizaci√≥n') ||
        first.join(' ').includes('localizacion') ||
        first.join(' ').includes('pdf');

      const dataRows = looksHeader ? rows.slice(1) : rows;

      if(!filters[alias]) filters[alias] = { __checked: true, groups: {} };

      for(const r of dataRows){
        const groupRaw = (r[0] ?? '').toString().trim();
        const company  = (r[1] ?? '').toString().trim();
        const place    = (r[2] ?? '').toString().trim();
        const pdfName  = (r[3] ?? '').toString().trim(); // ‚úÖ Col D

        if(!company || !place) continue;

        const groupKey = groupRaw || '(Sin grupo)';
        if(!(groupKey in filters[alias].groups)) filters[alias].groups[groupKey] = true;

        let coord = null;
        const maybeCoord = place.match(/^\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*$/);
        if(maybeCoord){
          coord = {lat: parseFloat(maybeCoord[1]), lng: parseFloat(maybeCoord[3])};
        } else {
          coord = await geocode(place);
        }
        if(!coord) continue;

        if(isDuplicateInSheet(alias, company, coord)) continue;

        addPoint({sheet: alias, group: groupKey, company, place, coord, pdfName});
        added++;
      }
    }

    renderLegend();
    applyFilters();

    if(added){
      if(bounds.length) map.fitBounds(bounds, {padding:[20,20]});
      layoutLabels();
      setStatus(`Cargado: ${added} punto(s) en ${Object.keys(filters).length} hoja(s).`);
    } else {
      setStatus('Excel le√≠do pero no se a√±adieron puntos. Revisa: A=Grupo, B=Empresa, C=Posici√≥n, D=PDF.');
    }
  }

  async function fetchArrayBuffer(url){
    const res = await fetch(url, { cache:'no-store' });
    if(!res.ok) throw new Error(`No encuentro ${url} (HTTP ${res.status})`);
    return await res.arrayBuffer();
  }

  // ===== AUTOLOAD FINAL =====
  try{
    // Logo
    if(AUTO.logoUrl){
      const img = document.getElementById('logoImg');
      img.src = AUTO.logoUrl;
      img.style.display = 'block';
    }

    setStatus('Descargando Excel del repo‚Ä¶');
    const ab = await fetchArrayBuffer(AUTO.excelUrl);

    await handleExcelArrayBuffer(ab);

    setStatus('Publicado y bloqueado ‚úÖ');
  }catch(e){
    console.error(e);
    setStatus('Error precargando:\n' + (e?.message || e));
  }
})();
</script>

</body>
</html>
